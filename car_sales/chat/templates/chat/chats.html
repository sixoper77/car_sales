{% extends "main/base.html" %}
{% load static %}

{% block title %}Чат - AutoSale{% endblock %}


{% block content %}
<div class="chat-container">
    <!-- Sidebar with chat list -->
    <aside class="chat-sidebar">
        <div class="sidebar-header">
            <h2>Повідомлення</h2>
            <div class="chat-search">
                <span class="material-icons">search</span>
                <input type="text" placeholder="Пошук чатів..." id="chatSearch">
            </div>
        </div>

        <div class="chat-list" id="chatList">
            {% if chats %}
                {% for chat in chats %}
                <div class="chat-item {% if chat.id == active_chat_id %}active{% endif %}" data-chat-id="{{ chat.id }}">
                    <div class="chat-avatar">
                        {% if chat.other_user.avatar %}
                            <img src="{{ chat.other_user.avatar.url }}" alt="{{ chat.other_user.username }}">
                        {% else %}
                            {{ chat.other_user.username|slice:":1"|upper }}
                        {% endif %}
                    </div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <span class="chat-name">{{ chat.other_user.username }}</span>
                            <span class="chat-time">{{ chat.last_message_time|date:"H:i" }}</span>
                        </div>
                        <div class="chat-preview">
                            {% if chat.last_message.sender == user %}
                                <span class="material-icons">done_all</span>
                            {% endif %}
                            {{ chat.last_message.text|truncatewords:5 }}
                        </div>
                    </div>
                    {% if chat.unread_count > 0 %}
                        <span class="unread-badge">{{ chat.unread_count }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <span class="material-icons">chat_bubble_outline</span>
                    <h3>Чатів поки що немає</h3>
                    <p>Почніть спілкування з продавцями або покупцями</p>
                </div>
            {% endif %}
        </div>
    </aside>

    <!-- Chat area -->
    <div class="chat-area" id="chatArea">
        {% if active_chat %}
            <!-- Chat header -->
            <div class="chat-header">
                <div class="chat-user-info">
                    <div class="chat-user-avatar">
                        {% if active_chat.other_user.avatar %}
                            <img src="{{ active_chat.other_user.avatar.url }}" alt="{{ active_chat.other_user.username }}">
                        {% else %}
                            {{ active_chat.other_user.username|slice:":1"|upper }}
                        {% endif %}
                    </div>
                    <div class="chat-user-details">
                        <h3>{{ active_chat.other_user.username }}</h3>
                        <span class="chat-user-status {% if active_chat.other_user.is_online %}online{% endif %}">
                            {% if active_chat.other_user.is_online %}
                                онлайн
                            {% else %}
                                був(ла) {{ active_chat.other_user.last_seen|timesince }} тому
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="icon-btn" title="Пошук в чаті">
                        <span class="material-icons">search</span>
                    </button>
                    <button class="icon-btn" title="Налаштування">
                        <span class="material-icons">more_vert</span>
                    </button>
                </div>
            </div>

            <!-- Messages area -->
            <div class="messages-area" id="messagesArea">
                {% for message in messages %}
                    {% comment %} {% if forloop.first or message.created_at.date != messages|slice:forloop.counter0|last.created_at.date %} {% endcomment %}
                        <div class="date-separator">
                            <span>{{ message.created_at|date:"d E Y" }}</span>
                        </div>
                    

                    <div class="message {% if message.sender == user %}own{% endif %}">
                        <div class="message-avatar">
                            {% if message.sender.avatar %}
                                <img src="{{ message.sender.avatar.url }}" alt="{{ message.sender.username }}">
                            {% else %}
                                {{ message.sender.username|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <div class="message-content">
                            <div class="message-bubble">
                                {{ message.text }}
                            </div>
                            <div class="message-meta">
                                <span class="message-time">{{ message.created_at|date:"H:i" }}</span>
                                {% if message.sender == user %}
                                    <div class="message-status">
                                        <span class="material-icons {% if message.is_read %}read{% endif %}">
                                            {% if message.is_read %}
                                                done_all
                                            {% else %}
                                                done
                                            {% endif %}
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Message input -->
            <div class="message-input-area">
                <form id="messageForm" method="post" action="{% url 'chat:send_message' active_chat.id %}">
                    {% csrf_token %}
                    <div class="message-input-container">
                        <textarea 
                            class="message-input" 
                            name="message_text" 
                            placeholder="Написати повідомлення..." 
                            rows="1"
                            id="messageInput"
                        ></textarea>
                        <div class="input-actions">
                            <button type="button" class="attach-btn" title="Прикріпити файл">
                                <span class="material-icons">attach_file</span>
                            </button>
                            <button type="submit" class="send-btn" id="sendBtn">
                                <span class="material-icons">send</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- Empty chat state -->
            <div class="empty-chat-state">
                <span class="material-icons">forum</span>
                <h3>Виберіть чат</h3>
                <p>Оберіть чат зі списку, щоб почати спілкування</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chat search functionality
    const chatSearch = document.getElementById('chatSearch');
    const chatItems = document.querySelectorAll('.chat-item');
    
    if (chatSearch) {
        chatSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            chatItems.forEach(item => {
                const name = item.querySelector('.chat-name').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Auto-resize textarea
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send message on Enter (Shift+Enter for new line)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('messageForm').submit();
            }
        });
    }

    // Scroll to bottom of messages
    const messagesArea = document.getElementById('messagesArea');
    if (messagesArea) {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // Chat item click handler
    chatItems.forEach(item => {
        item.addEventListener('click', function() {
            const chatId = this.dataset.chatId;
            window.location.href = `/chat/${chatId}/`;
        });
    });

    // AJAX form submission (optional)
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const messageText = formData.get('message_text').trim();
            
            if (!messageText) return;

            // Send via AJAX
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add message to chat
                    addMessageToChat(data.message);
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }

    function addMessageToChat(message) {
        const messagesArea = document.getElementById('messagesArea');
        const messageHTML = `
            <div class="message own">
                <div class="message-avatar">
                    ${message.sender_avatar ? 
                        `<img src="${message.sender_avatar}" alt="${message.sender_name}">` : 
                        message.sender_name.charAt(0).toUpperCase()
                    }
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${message.text}
                    </div>
                    <div class="message-meta">
                        <span class="message-time">${message.time}</span>
                        <div class="message-status">
                            <span class="material-icons">done</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        messagesArea.insertAdjacentHTML('beforeend', messageHTML);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
});
</script>
{% endblock %}