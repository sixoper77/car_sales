{% extends "main/base.html" %}
{% load static %}

{% block title %}Добавить автомобиль - AutoSale{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <div class="hero-text">
            <h1>Добавить автомобиль</h1>
            <p>Опубликуйте ваше объявление о продаже автомобиля</p>
        </div>

        <!-- Search Filters -->
        <div class="search-card">
            <form id="addCarForm" class="filter-form" action="{% url 'sale:add-car' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Main Filters Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <div class="dropdown" id="categoryDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Тип автомобиля</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for value, display in form.category.field.choices %}
                                    {% if value %}
                                        <div class="dropdown-item" data-value="{{ value }}">{{ display }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" name="category">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="regionDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Регион</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for value, display in form.region.field.choices %}
                                    {% if value %}
                                        <div class="dropdown-item" data-value="{{ value }}">{{ display }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" name="region">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="brandDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Марка</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for brand in form.brand.field.queryset %}
                                    <div class="dropdown-item brand-item" data-slug="{{ brand.slug }}" data-value="{{ brand.id }}">{{ brand.brand }}</div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="brand">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="modelDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Модель</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content" id="models">
                                <div class="dropdown-item" data-value="">Оберіть спочатку марку</div>
                            </div>
                            <input type="hidden" name="model">
                        </div>
                    </div>
                </div>

                <!-- Second Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <div class="dropdown" id="yearDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Рік випуску</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for value in ranges %}
                                    {% if value %}
                                        <div class="dropdown-item" data-value="{{ value }}">{{ value }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" name="year">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="colorDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Цвет</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for value, display in form.color.field.choices %}
                                    {% if value %}
                                        <div class="dropdown-item" data-value="{{ value }}">{{ display }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" name="color">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="gearboxDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Коробка передач</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for value, display in form.gearbox.field.choices %}
                                    {% if value %}
                                        <div class="dropdown-item" data-value="{{ value }}">{{ display }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" name="gearbox">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="airConditionerDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Кондиционер</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for value, display in form.air_conditioner.field.choices %}
                                    {% if value %}
                                        <div class="dropdown-item" data-value="{{ value }}">{{ display }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" name="air_conditioner">
                        </div>
                    </div>
                </div>

                <!-- Third Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <div class="dropdown" id="usedDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Нова/БУ</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for value, display in form.used.field.choices %}
                                    {% if value != None %}
                                        <div class="dropdown-item" data-value="{{ value }}">{{ display }}</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" name="used">
                        </div>
                    </div>

                    <div class="filter-group price-group">
                        <div class="price-inputs">
                            <input type="number" name="price" placeholder="Ціна" class="price-input">
                            <span class="currency">$</span>
                        </div>
                    </div>

                    <div class="filter-group price-group">
                        <div class="price-inputs">
                            <input type="number" name="discount" placeholder="Скидка %" class="price-input" value="0">
                            <span class="currency">%</span>
                        </div>
                    </div>

                    <div class="filter-group price-group">
                        <div class="price-inputs">
                            <input type="number" name="mileage" placeholder="Пробег" class="price-input" step="0.01">
                            <span class="currency">км</span>
                        </div>
                    </div>
                </div>

                <!-- Fourth Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <div class="file-upload">
                            <input type="file" name="images" id="imageInput" accept="image/*" multiple>
                            <label for="imageInput" class="file-label">
                                <span class="material-icons">upload</span>
                                Загрузить фото (до 15 шт.)
                            </label>
                        </div>
                    </div>

                    <div class="filter-group search-group">
                        <button type="submit" class="btn-primary search-btn">
                            <span class="material-icons">publish</span>
                            Опубликовать
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById('addCarForm');
    const modelsContainer = document.getElementById('models');
    const brandHidden = document.querySelector('#brandDropdown input[type="hidden"]');
    const modelHidden = document.querySelector('#modelDropdown input[type="hidden"]');
    const imageInput = document.getElementById('imageInput');
    
    // Массив для накопления файлов
    let allFiles = [];

    // Общий обработчик клика
    document.addEventListener('click', function(e) {
        const toggle = e.target.closest('.dropdown-button');
        const item = e.target.closest('.dropdown-item');

        // Dropdown toggle
        if(toggle && toggle.closest('.dropdown')) {
            const dropdown = toggle.closest('.dropdown');
            const isActive = dropdown.classList.contains('active');
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
            if(!isActive) dropdown.classList.add('active');
            return;
        }

        // Выбор dropdown item
        if(item) {
            const dropdown = item.closest('.dropdown') || item.closest('#models')?.closest('.dropdown');
            const dropdownText = dropdown ? dropdown.querySelector('.dropdown-text') : null;
            const hiddenInput = dropdown ? dropdown.querySelector('input[type="hidden"]') : null;

            // Brand selection -> load models
            if(item.classList.contains('brand-item')) {
                const brandSlug = item.dataset.slug;
                const brandId = item.dataset.value;
                if(dropdownText) dropdownText.textContent = item.textContent.trim();
                if(hiddenInput) hiddenInput.value = brandId;
                dropdown.classList.remove('active');

                modelHidden.value = "";
                const modelText = document.querySelector('#modelDropdown .dropdown-text');
                if(modelText) modelText.textContent = 'Завантаження...';
                modelsContainer.innerHTML = '<div class="dropdown-item">Завантаження моделей...</div>';

                fetch(`/get-models/${encodeURIComponent(brandSlug)}/`)
                .then(resp => resp.json())
                .then(models => {
                    modelsContainer.innerHTML = '';
                    if(!models || models.length===0){
                        modelsContainer.innerHTML = '<div class="dropdown-item">Немає моделей</div>';
                        if(modelText) modelText.textContent = 'Немає моделей';
                    } else {
                        models.forEach(m=>{
                            const div = document.createElement('div');
                            div.className = 'dropdown-item';
                            div.dataset.value = m.id;
                            div.textContent = m.models;
                            modelsContainer.appendChild(div);
                        });
                        if(modelText) modelText.textContent = 'Оберіть модель';
                    }
                }).catch(err=>{
                    console.error('Ошибка загрузки моделей:', err);
                    modelsContainer.innerHTML = '<div class="dropdown-item">Помилка завантаження</div>';
                    if(modelText) modelText.textContent = 'Помилка завантаження';
                    modelHidden.value = '';
                });
                return;
            }

            // Model selection
            if(item.parentElement && item.parentElement.id==='models'){
                const modelDropdown = document.getElementById('modelDropdown');
                const modelDropdownText = modelDropdown.querySelector('.dropdown-text');
                const hidden = modelDropdown.querySelector('input[type="hidden"]');
                if(modelDropdownText) modelDropdownText.textContent = item.textContent.trim();
                if(hidden) hidden.value = item.dataset.value || '';
                modelDropdown.classList.remove('active');
                return;
            }

            // Other dropdown
            if(dropdownText && hiddenInput){
                dropdownText.textContent = item.textContent.trim();
                hiddenInput.value = item.dataset.value || '';
                dropdown.classList.remove('active');
            }
            return;
        }

        // Close dropdown if click outside
        if(!e.target.closest('.dropdown')){
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
        }
    });

    // НАКОПЛЕНИЕ ФАЙЛОВ при каждом выборе
    imageInput.addEventListener('change', function(e) {
        const newFiles = Array.from(e.target.files);
        
        // Добавляем новые файлы к существующим
        newFiles.forEach(file => {
            // Проверяем что такого файла еще нет (по имени и размеру)
            const exists = allFiles.some(f => f.name === file.name && f.size === file.size);
            if(!exists && allFiles.length < 15) {
                allFiles.push(file);
            }
        });
        
        // Обновляем текст label
        const fileLabel = document.querySelector('.file-label');
        if(fileLabel) {
            fileLabel.innerHTML = `
                <span class="material-icons">upload</span>
                Загружено: ${allFiles.length} из 15 фото
            `;
        }
        
        console.log(`Всего файлов в массиве: ${allFiles.length}`);
        allFiles.forEach((file, idx) => {
            console.log(`  ${idx + 1}. ${file.name}`);
        });
        
        if(allFiles.length >= 15) {
            alert('Достигнут лимит: 15 фотографий');
        }
        
        // Очищаем input чтобы можно было выбрать те же файлы снова
        imageInput.value = '';
    });

    // Submit form с накопленными файлами
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if(allFiles.length === 0) {
            alert('Добавьте хотя бы одно фото!');
            return;
        }
        
        console.log(`=== ОТПРАВКА ${allFiles.length} ФАЙЛОВ ===`);
        
        const formData = new FormData();
        
        // CSRF токен
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Все скрытые поля
        const hiddenInputs = form.querySelectorAll('input[type="hidden"]:not([name="csrfmiddlewaretoken"])');
        hiddenInputs.forEach(input => {
            if(input.name && input.value) {
                formData.append(input.name, input.value);
            }
        });
        
        // Числовые поля
        const numberInputs = form.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            if(input.name && input.value) {
                formData.append(input.name, input.value);
            }
        });
        
        // ДОБАВЛЯЕМ ВСЕ НАКОПЛЕННЫЕ ФАЙЛЫ
        allFiles.forEach((file, idx) => {
            formData.append('images', file);
            console.log(`Файл ${idx + 1}: ${file.name} (${(file.size/1024).toFixed(2)} KB)`);
        });
        
        // Отправка
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if(response.ok) {
                console.log('✓ Успешно отправлено!');
                window.location.href = '/';
            } else {
                return response.text().then(text => {
                    console.error('Ошибка сервера:', text);
                    alert('Ошибка при сохранении');
                });
            }
        })
        .catch(error => {
            console.error('Ошибка отправки:', error);
            alert('Ошибка при отправке формы');
        });
    });
});
</script>
{% endblock %}