{% extends "main/base.html" %}
{% load cache %}
{% load static %}
{% load currency %}
{% load humanize %}
{% block title %}{{ car.brand.name }} {{ car.model.name }} - CarMarket{% endblock %}

{% block content %}
<div class="car-detail-container">
    <!-- Left Panel - Car Information -->
    <div class="car-info-panel">
        <button class="favorite-btn">
            <span class="material-icons">favorite_border</span>
        </button>
        
        <div class="car-title-info">
            <h1>{{ car.brand }} {{ car.model }} {{ car.year }}</h1>
            <div class="car-subtitle">{{ car.get_type_display }} • {{ car.category.name }}</div>
        </div>

        <div class="car-price-section">
            <div class="car-main-price">${{ car.price|floatformat:2|intcomma }}</div>
            <div class="car-price-details">≈ {{ car.price|usd_to_uah|intcomma }} грн</div>
        </div>

        <div class="car-views">
            <span class="material-icons" style="font-size: 14px;">visibility</span>
            <span>{{car.views.count|intcomma}} переглядів</span>
        </div>

        <div class="seller-section">
            <div class="seller-label">Професійний продавець</div>
            
            <div class="seller-info">
                <div class="seller-avatar">
                    <img src="{{car.owner.image.url}}" alt="" class="seller-avatar">
                </div>
                <div class="seller-details">
                    <a href="{% url "users:profile_" car.owner.username %}">
                        <h4>{{ car.owner.username }}</h4>
                    </a>
                    <div class="seller-online">Был в сети {{car.owner.last_active|date:"d.m.Y H:i"}}</div>
                </div>
            </div>
            
            <div class="seller-location">{{ car.region }}</div>
            
            <div class="seller-verification">
                <div class="verification-item">
                    <span class="material-icons">verified</span>
                    <span>Перевірений власник</span>
                </div>
                <div class="verification-item">
                    <span class="material-icons">phone_verified</span>
                    <span>Перевірений телефон</span>
                </div>
            </div>

            <div class="seller-phone">
                <span class="material-icons">phone</span>
                <span>(073) XXX-XX-XX</span>
                <span class="phone-toggle">показати</span>
            </div>
        </div>
        {% if user != car.owner %}
        <div class="action-buttons">
            <a class="btn-chat" href="{% url "chat:chats" car.owner.username %}">
                <span class="material-icons">message</span>
                Написати в чат
            </a>
            <button class="btn-callback">
                <span class="material-icons">phone_callback</span>
                Передзвонити авто
            </button>
            <div class="callback-hours">Тільки • По 11:00-20:00</div>
        </div>
        {% endif %}
    </div>

    <!-- Right Panel - Images and Details -->
    {% cache 180 car_detail car.id %}
    <div class="car-images-panel">
        <!-- Main Image -->
        <div class="main-image-container">
            {% if car.images.all|length > 1 %}
                {% for image in car.images.all  %}
                    <img src="{{image.image.url}}" alt="" class="main-car-image" data-index="{{forloop.counter0}}">
                {% endfor %}
            {% elif car.images.first %}
                <img src="{{car.images.first.image.url}}" alt="" class="main-car-image" data-index="0"
            {% endif %}
            
            
            <div class="source-badge">auto.ria</div>
            
            <button class="image-nav-btn nav-prev">
                <span class="material-icons">chevron_left</span>
            </button>
            <button class="image-nav-btn nav-next">
                <span class="material-icons">chevron_right</span>
            </button>



            <div class="image-counter">
                <span class="material-icons" style="font-size: 14px; margin-right: 4px;">camera_alt</span>
                23 з 56
            </div>
        </div>

        <!-- Image Thumbnails -->
        <div class="image-thumbnails">
            <div class="image-thumbnails">
                {% for image in car.images.all %}
                <div class="thumbnail {% if forloop.first %}active{% endif %}" data-index="{{forloop.counter0}}">
                    <img src="{{image.image.url}}" alt="Фото {{forloop.counter}}">
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Car Details Section -->
        
        <div class="car-details-section">
            <h2 class="details-title">{{ car.brand }} {{ car.model }} {{ car.year }}</h2>
            <div class="details-subtitle">•{{ car.category}}</div>
            
            <div class="additional-info">
                <div class="info-item">Стан:{% if car.used %}Б/У{% else %}Новий{% endif %}</div>
                <div class="info-item">Пробег: {{car.mileage|intcomma}}км</div>
                <div class="info-item">Коробка передач: {{car.get_gearbox_display}}</div>
                <div class="info-item">Кондиционер: {{car.get_air_conditioner_display}}</div>
            </div>

            <div class="verification-info">
                <div>Перевірено AUTO.RIA на реєстрацію МВС</div>
                <div class="update-date">{% if car.updated %}{{car.updated}}{% else %}{{car.created}}{% endif %}</div>
      

                <div class="vin-info">
                    <div class="vin-item">
                        <strong>АТ 2244 IC</strong>
                    </div>
                    <div class="vin-item">
                        <span class="material-icons" style="font-size: 12px;">verified</span>
                        Перевірений VIN код
                    </div>
                    <div class="vin-item">
                        <strong>ITALSXDRXE6300268</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endcache %}
</div>
<script>
    
    const images = document.querySelectorAll('.main-car-image');
    const thumbnails = document.querySelectorAll('.thumbnail');
    const prevBtn = document.querySelector('.image-nav-btn.nav-prev');
    const nextBtn = document.querySelector('.image-nav-btn.nav-next');
    const imageCounter = document.querySelector('.image-counter');
    let currentIndex = 0;

    // Функция обновления отображения
    function updateGallery() {
        // Скрываем все изображения
        images.forEach(img => img.style.display = 'none');
        
        // Показываем текущее изображение
        if (images[currentIndex]) {
            images[currentIndex].style.display = 'block';
        }
        
        // Обновляем активную миниатюру
        thumbnails.forEach((thumb, index) => {
            thumb.classList.remove('active');
            if (index === currentIndex) {
                thumb.classList.add('active');
            }
        });
        
        // Обновляем счетчик
        if (imageCounter && images.length > 0) {
            imageCounter.innerHTML = `
                <span class="material-icons" style="font-size: 14px; margin-right: 4px;">camera_alt</span>
                ${currentIndex + 1} з ${images.length}
            `;
        }
    }

    // Инициализация галереи
    if (images.length > 0) {
        updateGallery();
        
        // Если только одно изображение - скрываем кнопки навигации
        if (images.length === 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        } else {
            // Обработчик кнопки "назад"
            prevBtn.addEventListener('click', () => {
                currentIndex = (currentIndex - 1 + images.length) % images.length;
                updateGallery();
            });
            
            // Обработчик кнопки "вперед"
            nextBtn.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % images.length;
                updateGallery();
            });
        }
        
        // Клик по миниатюрам
        thumbnails.forEach((thumb, index) => {
            if (index < images.length) {
                thumb.style.cursor = 'pointer';
                thumb.addEventListener('click', () => {
                    currentIndex = index;
                    updateGallery();
                });
            }
        });
        
        // Поддержка клавиатуры (стрелки влево/вправо)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                currentIndex = (currentIndex - 1 + images.length) % images.length;
                updateGallery();
            } else if (e.key === 'ArrowRight') {
                currentIndex = (currentIndex + 1) % images.length;
                updateGallery();
            }
        });
    }
</script> 
{% endblock %}