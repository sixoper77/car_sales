{% extends "main/base.html" %}
{% load static %}
{% load humanize %}
{% block title %}AutoSale - Купівля та продаж автомобілів{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="hero-content">
        <div class="hero-text">
            <h1>Знайдіть свій ідеальний автомобіль</h1>
            <p>Найбільший вибір вживаних та нових автомобілів в Україні</p>
        </div>

        <!-- Search Filters -->
        <div class="search-card">
            <form id="filterForm" class="filter-form" action="{% url 'search:search-car' %}" method="get">
                <!-- Main Filters Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <div class="dropdown" id="typeDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Легкові</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for _,type in types %}
                                    <div class="dropdown-item" data-value="{{ type }}">{{type}}</div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="type">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="regionDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Регіон</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for _,region in regions %}
                                    <div class="dropdown-item" data-value="{{region}}">{{region}}</div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="region">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="brandDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Марка</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for brand in brands %}
                                    <div class="dropdown-item brand-item" data-slug="{{brand.slug}}" data-value="{{brand.slug}}">{{brand.brand}}</div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="brand">
                        </div>
                    </div>

                    <div class="filter-group">
                        <div class="dropdown" id="modelDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Модель</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content" id="models">
                                <div class="dropdown-item" data-value="">Оберіть спочатку марку</div>
                            </div>
                            <input type="hidden" name="model">
                        </div>
                    </div>
                </div>

                <!-- Second Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <div class="dropdown" id="yearDropdown">
                            <button type="button" class="dropdown-button">
                                <span class="dropdown-text">Рік випуску</span>
                                <span class="material-icons">expand_more</span>
                            </button>
                            <div class="dropdown-content">
                                {% for i in ranges %}
                                    <div class="dropdown-item" data-value="{{i}}">{{i}}</div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="year">
                        </div>
                    </div>

                    <div class="filter-group price-group">
                        <div class="price-inputs">
                            <input type="number" name="price_min" placeholder="Ціна від" class="price-input">
                            <span class="price-separator">—</span>
                            <input type="number" name="price_max" placeholder="до" class="price-input">
                            <span class="currency">$</span>
                        </div>
                    </div>

                    <div class="filter-group search-group">
                        <button type="submit" class="btn-primary search-btn">
                            <span class="material-icons">search</span>
                            Пошук
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Featured Section -->
<section class="featured-section">
    <div class="container">
        <h2>Рекомендовані авто</h2>
        <div class="cars-grid">
            {% for car in page_obj  %}
                <div class="car-card">
                    <div class="car-image">
                        <div class="placeholder-image">
                            <img src="{{car.image.url}}" alt="" class="card-image">
                        </div>
                        <div class="car-badge">ТОП</div>
                    </div>
                    <div class="car-info">
                        <a href="{{ car.get_absolute_url }}">
                            <h3>{{car.brand}}-{{car.model}}-{{car.year}}</h3>
                        </a>
                        <p class="car-details">Owner: {{car.owner}} color:{{car.color}}</p>
                        <p class="car-price">${{car.price|intcomma}}</p>
                        <div class="car-location">
                            <span class="material-icons">location_on</span>
                            {{car.region}}
                        </div>
                    </div>
                </div>
                {% endfor %}
            
        </div>
        <ul class="pagination">
            <li class="{% if not page_obj.has_previous %}disabled{% endif %}">
                <a href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}{% endif %}">Previous</a>
            </li>
            {% for page in page_obj.paginator.page_range  %}
            {% if page >= page_obj.number|add:-2 and page <= page_obj.number|add:2%}
                <li>
                    <a href="?page={{page}}"class="{% if page_obj.number == page %}disabled{% endif %}">{{page}}</a>
                </li>
                {% endif %}
            {% endfor %}
            <li class="{% if not page_obj.has_next %}disabled{% endif %}">
                <a href="{% if page_obj.has_next %}?page={{page_obj.next_page_number}}{% endif %}">Next</a>
            </li>
        </ul>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById('filterForm');
    const modelsContainer = document.getElementById('models');
    const brandHidden = document.querySelector('#brandDropdown input[type="hidden"]');
    const modelHidden = document.querySelector('#modelDropdown input[type="hidden"]');

    // Общий обработчик клика
    document.addEventListener('click', function(e) {
        const toggle = e.target.closest('.dropdown-button');
        const item = e.target.closest('.dropdown-item');

        // Dropdown toggle
        if(toggle && toggle.closest('.dropdown')) {
            const dropdown = toggle.closest('.dropdown');
            const isActive = dropdown.classList.contains('active');
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
            if(!isActive) dropdown.classList.add('active');
            return;
        }

        // Выбор dropdown item
        if(item) {
            const dropdown = item.closest('.dropdown') || item.closest('#models')?.closest('.dropdown');
            const dropdownText = dropdown ? dropdown.querySelector('.dropdown-text') : null;
            const hiddenInput = dropdown ? dropdown.querySelector('input[type="hidden"]') : null;

            // Brand selection -> load models
            if(item.classList.contains('brand-item')) {
                const brandSlug = item.dataset.slug;
                if(dropdownText) dropdownText.textContent = item.textContent.trim();
                if(hiddenInput) hiddenInput.value = brandSlug;
                dropdown.classList.remove('active');

                modelHidden.value = "";
                const modelText = document.querySelector('#modelDropdown .dropdown-text');
                if(modelText) modelText.textContent = 'Завантаження...';
                modelsContainer.innerHTML = '<div class="dropdown-item">Завантаження моделей...</div>';

                fetch(`/get-models/${encodeURIComponent(brandSlug)}/`)
                .then(resp => resp.json())
                .then(models => {
                    modelsContainer.innerHTML = '';
                    if(!models || models.length===0){
                        modelsContainer.innerHTML = '<div class="dropdown-item">Немає моделей</div>';
                        if(modelText) modelText.textContent = 'Немає моделей';
                    } else {
                        models.forEach(m=>{
                            const div = document.createElement('div');
                            div.className = 'dropdown-item';
                            div.dataset.value = m.id;
                            div.textContent = m.models;
                            modelsContainer.appendChild(div);
                        });
                        if(modelText) modelText.textContent = 'Оберіть модель';
                    }
                }).catch(err=>{
                    console.error('Ошибка загрузки моделей:', err);
                    modelsContainer.innerHTML = '<div class="dropdown-item">Помилка завантаження</div>';
                    if(modelText) modelText.textContent = 'Помилка завантаження';
                    modelHidden.value = '';
                });
                return;
            }

            // Model selection
            if(item.parentElement && item.parentElement.id==='models'){
                const modelDropdown = document.getElementById('modelDropdown');
                const modelDropdownText = modelDropdown.querySelector('.dropdown-text');
                const hidden = modelDropdown.querySelector('input[type="hidden"]');
                if(modelDropdownText) modelDropdownText.textContent = item.textContent.trim();
                if(hidden) hidden.value = item.dataset.value || '';
                modelDropdown.classList.remove('active');
                return;
            }

            // Other dropdown
            if(dropdownText && hiddenInput){
                dropdownText.textContent = item.textContent.trim();
                hiddenInput.value = item.dataset.value || '';
                dropdown.classList.remove('active');
            }
            return;
        }

        // Close dropdown if click outside
        if(!e.target.closest('.dropdown')){
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
        }
    });

    // Submit form
    form.addEventListener('submit', function(e) {
        console.log('Submitting form with GET params:', new URLSearchParams(new FormData(form)).toString());
        // форма отправится обычным GET
    });
});
</script>
{% endblock %}



