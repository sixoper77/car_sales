{% extends "account/base_entrance.html" %}
{% load i18n %}
{% load allauth %}
{% load static %}
{% block head_title %}
    {% trans "Change Password" %}
{% endblock head_title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/reset_password_key.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
    {% if messages %}
    <div class="message-container">
        {% for message in messages %}
        <div class="message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if token_fail %}
        <h1>{% trans "Bad Token" %}</h1>
        <div class="subtitle">
            {% url 'account_reset_password' as passwd_reset_url %}
            {% blocktrans %}The password reset link was invalid, possibly because it has already been used. Please request a <a href="{{ passwd_reset_url }}">new password reset</a>.{% endblocktrans %}
        </div>
    {% else %}
        <h1>{% trans "Change Password" %}</h1>
        <div class="subtitle">
            {% trans "Enter your new password below." %}
        </div>

        <form method="post" action="{{ action_url }}">
            {% csrf_token %}
            {{ redirect_field }}

            {% if form.non_field_errors %}
            <div class="form-errors">
                {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}

            {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                <div class="input-wrapper">
                    {{ field }}
                    {% if field.name == 'password1' or field.name == 'password2' %}
                    <button type="button" class="password-toggle" onclick="togglePassword('{{ field.id_for_label }}', this)">
                        üëÅÔ∏è
                    </button>
                    {% endif %}
                </div>
                {% if field.help_text %}
                <div class="help-text">{{ field.help_text|safe }}</div>
                {% endif %}
                {% if field.errors %}
                {% for error in field.errors %}
                <div class="error-text">{{ error }}</div>
                {% endfor %}
                {% endif %}
            </div>
            {% endfor %}

            <button type="submit" name="action" class="submit-btn">
                {% trans 'Change Password' %}
            </button>

            <button type="submit" form="logout-from-stage" class="cancel-btn">
                {% translate "Cancel" %}
            </button>
        </form>
    {% endif %}

    {% if not cancel_url %}
    <form id="logout-from-stage" method="post" action="{% url 'account_logout' %}">
        <input type="hidden" name="next" value="{% url 'account_login' %}">
        {% csrf_token %}
    </form>
    {% endif %}
</div>

<script>
function togglePassword(fieldId, button) {
    const field = document.getElementById(fieldId);
    if (field.type === 'password') {
        field.type = 'text';
        button.textContent = 'üôà';
    } else {
        field.type = 'password';
        button.textContent = 'üëÅÔ∏è';
    }
}
</script>
{% endblock content %}